<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>CHORD SLAYER | TACTICAL OPS</title>
    <link href="https://fonts.googleapis.com/css2?family=Rajdhani:wght@500;700&family=Teko:wght@300;600&display=swap" rel="stylesheet">
    <style>
        :root {
            --holo-cyan: #00f0ff;
            --holo-blue: #00a8ff;
            --holo-dark: #05101a;
            --alert-red: #ff3333;
            --amber-glow: #ffae00; 
            --amber-dim: #5c3d00;
            --green-signal: #00ff41;
            --pink-flux: #ff0055; 
            --purple-nebula: #bd00ff;
            --hud-bg: rgba(5, 20, 30, 0.95);
            --glass-border: 1px solid rgba(0, 240, 255, 0.3);
        }

        * { box-sizing: border-box; margin: 0; padding: 0; user-select: none; }
        
        body {
            background-color: #020204;
            color: var(--holo-cyan);
            font-family: 'Rajdhani', sans-serif;
            overflow: hidden; 
            height: 100vh;
            width: 100vw;
            background-image: 
                radial-gradient(circle at 50% 50%, rgba(0, 40, 80, 0.3) 0%, transparent 70%);
        }

        /* --- HUD BACKGROUND FX --- */
        #grid-canvas {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            z-index: -1;
            opacity: 0.4;
        }

        .vignette {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: radial-gradient(circle, transparent 60%, #000 100%);
            pointer-events: none;
            z-index: 10;
        }

        .back-btn {
            position: fixed;
            top: 20px; left: 20px;
            color: rgba(255,255,255,0.6);
            background: rgba(0,0,0,0.5);
            border: 1px solid rgba(255,255,255,0.3);
            padding: 8px 16px;
            font-family: 'Rajdhani';
            font-size: 1rem;
            font-weight: bold;
            cursor: pointer;
            z-index: 100;
            backdrop-filter: blur(5px);
            text-transform: uppercase;
            transition: 0.3s;
            border-radius: 0; 
        }
        .back-btn:hover { color: white; border-color: var(--holo-cyan); background: rgba(0, 240, 255, 0.1); }

        /* --- SCREENS --- */
        .screen {
            position: absolute;
            width: 100%; height: 100%;
            display: flex; flex-direction: column;
            justify-content: center; align-items: center;
            transition: all 0.6s cubic-bezier(0.16, 1, 0.3, 1);
            opacity: 0; pointer-events: none;
            transform: scale(1.05) translateY(20px);
            filter: blur(10px);
            padding: 20px; 
        }

        .screen.active {
            opacity: 1; pointer-events: all;
            transform: scale(1) translateY(0);
            filter: blur(0);
        }

        /* --- SCREEN 1: INTRO --- */
        .hero-title {
            font-family: 'Teko', sans-serif;
            font-size: 8rem;
            line-height: 0.8;
            text-transform: uppercase;
            letter-spacing: 5px;
            text-align: center;
            text-shadow: 0 0 20px var(--holo-blue);
            position: relative;
        }
        
        .hero-title::after {
            content: ''; display: block;
            width: 200px; height: 4px;
            background: var(--holo-cyan);
            margin: 20px auto;
            box-shadow: 0 0 10px var(--holo-cyan);
        }

        .btn-group {
            display: flex; gap: 20px; margin-top: 40px; flex-wrap: wrap; justify-content: center;
        }

        .init-btn {
            background: transparent;
            color: var(--holo-cyan);
            border: 1px solid var(--holo-cyan);
            padding: 15px 50px;
            font-family: 'Rajdhani';
            font-weight: 700;
            font-size: 1.5rem;
            text-transform: uppercase;
            letter-spacing: 2px;
            cursor: pointer;
            transition: 0.3s;
            clip-path: polygon(10% 0, 100% 0, 100% 70%, 90% 100%, 0 100%, 0 30%);
        }
        .init-btn:hover {
            background: rgba(0, 240, 255, 0.1);
            text-shadow: 0 0 10px white;
            box-shadow: 0 0 20px var(--holo-cyan);
            transform: translateY(-2px);
        }

        /* Variant Button (Gold/Amber) */
        .init-btn.variant {
            color: var(--amber-glow);
            border-color: var(--amber-glow);
        }
        .init-btn.variant:hover {
            background: rgba(255, 174, 0, 0.1);
            box-shadow: 0 0 20px var(--amber-glow);
        }

        /* Green Button (Tuner) */
        .init-btn.green {
            color: var(--green-signal);
            border-color: var(--green-signal);
        }
        .init-btn.green:hover {
            background: rgba(0, 255, 65, 0.1);
            box-shadow: 0 0 20px var(--green-signal);
        }

        /* Pink Button (Rhythm) */
        .init-btn.pink {
            color: var(--pink-flux);
            border-color: var(--pink-flux);
        }
        .init-btn.pink:hover {
            background: rgba(255, 0, 85, 0.1);
            box-shadow: 0 0 20px var(--pink-flux);
        }

        /* Purple Button (Radar) */
        .init-btn.purple {
            color: var(--purple-nebula);
            border-color: var(--purple-nebula);
        }
        .init-btn.purple:hover {
            background: rgba(189, 0, 255, 0.1);
            box-shadow: 0 0 20px var(--purple-nebula);
        }

        /* --- TACTICAL PANEL --- */
        .tactical-panel {
            width: 600px; max-width: 100%;
            background: var(--hud-bg);
            border: 2px solid rgba(0, 240, 255, 0.5); 
            backdrop-filter: blur(10px);
            padding: 40px;
            position: relative;
            box-shadow: 0 0 30px rgba(0,0,0,0.5);
            scrollbar-width: thin;
            scrollbar-color: var(--holo-cyan) rgba(0, 0, 0, 0.3);
        }
        
        /* Custom Tactical Scrollbar */
        .tactical-panel::-webkit-scrollbar { width: 8px; }
        .tactical-panel::-webkit-scrollbar-track { background: rgba(0, 0, 0, 0.3); border-left: 1px solid rgba(255, 255, 255, 0.1); }
        .tactical-panel::-webkit-scrollbar-thumb { background: var(--holo-cyan); border-radius: 0; box-shadow: 0 0 10px var(--holo-cyan); }
        .tactical-panel::-webkit-scrollbar-thumb:hover { background: white; }
        
        /* Corner Markers */
        .panel-accent { position: absolute; width: 20px; height: 20px; border: 2px solid var(--holo-cyan); pointer-events: none; }
        .pa-tl { top: 0; left: 0; border-right: 0; border-bottom: 0; }
        .pa-tr { top: 0; right: 0; border-left: 0; border-bottom: 0; }
        .pa-bl { bottom: 0; left: 0; border-right: 0; border-top: 0; }
        .pa-br { bottom: 0; right: 0; border-left: 0; border-top: 0; }

        .input-group { display: flex; flex-direction: column; gap: 10px; }

        .tactical-input {
            background: rgba(0,0,0,0.3); border: 1px solid #334; color: white;
            font-family: 'Rajdhani'; font-size: 2rem; padding: 15px; outline: none;
            text-transform: uppercase; transition: 0.3s; width: 100%; border-radius: 0;
        }
        .tactical-input:focus { border-color: var(--holo-cyan); box-shadow: 0 0 15px rgba(0, 240, 255, 0.2); }

        /* --- SCREEN 3: TARGET SELECT (and Rhythm Search) --- */
        .list-container {
            width: 90%; max-width: 1000px; height: 60vh; display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 20px;
            overflow-y: auto; padding: 10px; scrollbar-width: thin;
            scrollbar-color: var(--holo-cyan) rgba(0,0,0,0.3);
        }
        .list-container::-webkit-scrollbar { width: 6px; }
        .list-container::-webkit-scrollbar-thumb { background: var(--holo-cyan); }

        .data-card {
            background: rgba(0, 20, 40, 0.6); border: 1px solid rgba(0, 168, 255, 0.2);
            padding: 15px; display: flex; align-items: center; gap: 15px;
            cursor: pointer; transition: 0.3s; position: relative; overflow: hidden; border-radius: 0;
        }
        .data-card:hover { background: rgba(0, 168, 255, 0.15); border-color: var(--holo-cyan); transform: translateY(-2px); }
        .data-card:hover::before { content: ''; position: absolute; left: 0; top: 0; bottom: 0; width: 4px; background: var(--holo-cyan); }
        .card-img { width: 50px; height: 50px; background: #000; border: 1px solid #333; object-fit: cover; flex-shrink: 0; }

        /* --- SCREEN 4: DEPLOYMENT --- */
        .deploy-header { text-align: center; margin-bottom: 20px; }
        .deploy-grid { display: flex; gap: 40px; margin-top: 10px; perspective: 1000px; width: 100%; justify-content: center; flex-wrap: wrap; }
        .deploy-card { width: 220px; height: 300px; background: linear-gradient(135deg, rgba(5,20,30,0.9), rgba(0,10,20,0.95)); border: 1px solid rgba(0, 240, 255, 0.2); display: flex; flex-direction: column; justify-content: space-between; padding: 20px; transition: 0.4s; cursor: pointer; position: relative; border-radius: 0; }
        .deploy-card:hover { transform: translateY(-10px) scale(1.05); border-color: var(--holo-cyan); box-shadow: 0 0 30px rgba(0, 240, 255, 0.1); }
        .deploy-icon { font-size: 3rem; text-align: center; margin-top: 20px; filter: drop-shadow(0 0 10px var(--holo-blue)); }
        .deploy-name { text-align: center; font-family: 'Teko'; font-size: 2rem; color: white; }
        .deploy-btn { width: 100%; padding: 10px; background: rgba(0, 240, 255, 0.1); border: 1px solid var(--holo-cyan); color: var(--holo-cyan); text-align: center; text-transform: uppercase; font-weight: bold; transition: 0.2s; border-radius: 0; }
        .deploy-card:hover .deploy-btn { background: var(--holo-cyan); color: black; }

        /* --- THEME OVERRIDES --- */
        #screen-chords .tactical-panel, #screen-about .tactical-panel, #screen-tuner .tactical-panel, #screen-scales .tactical-panel, #screen-metronome .tactical-panel, #screen-radar .tactical-panel {
            border-color: var(--amber-glow); width: 900px; display: flex; gap: 40px;
        }
        #screen-about .tactical-panel, #screen-more .tactical-panel { flex-direction: column; gap: 20px; }
        
        /* Color Swaps */
        #screen-chords .panel-accent, #screen-about .panel-accent, #screen-more .panel-accent { border-color: var(--amber-glow); }
        #screen-chords .back-btn:hover, #screen-about .back-btn:hover, #screen-more .back-btn:hover { border-color: var(--amber-glow); background: rgba(255, 174, 0, 0.1); color: white; }
        
        #screen-tuner .tactical-panel { border-color: var(--green-signal); }
        #screen-tuner .panel-accent { border-color: var(--green-signal); }
        #screen-tuner .back-btn:hover { border-color: var(--green-signal); background: rgba(0, 255, 65, 0.1); color: white; }

        #screen-scales .tactical-panel { border-color: var(--holo-blue); width: 1000px; flex-direction: column; }
        #screen-scales .panel-accent { border-color: var(--holo-blue); }
        #screen-scales .back-btn:hover { border-color: var(--holo-blue); background: rgba(0, 168, 255, 0.1); color: white; }

        #screen-metronome .tactical-panel { border-color: var(--pink-flux); flex-direction: column; text-align: center; }
        #screen-metronome .panel-accent { border-color: var(--pink-flux); }
        #screen-metronome .back-btn:hover { border-color: var(--pink-flux); background: rgba(255, 0, 85, 0.1); color: white; }

        #screen-radar .tactical-panel { border-color: var(--purple-nebula); flex-direction: column; text-align: center; }
        #screen-radar .panel-accent { border-color: var(--purple-nebula); }
        #screen-radar .back-btn:hover { border-color: var(--purple-nebula); background: rgba(189, 0, 255, 0.1); color: white; }


        /* --- CHORD UI --- */
        .chord-ui-left { flex: 1; display: flex; flex-direction: column; gap: 20px; }
        .chord-ui-right { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; border-left: 1px solid rgba(255, 174, 0, 0.2); padding-left: 40px; }
        .keypad-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; }
        .key-btn { background: rgba(0,0,0,0.5); border: 1px solid var(--amber-dim); color: var(--amber-glow); padding: 15px 0; text-align: center; font-family: 'Teko'; font-size: 1.5rem; cursor: pointer; transition: 0.2s; border-radius: 0; }
        .key-btn.active { background: var(--amber-glow); color: black; box-shadow: 0 0 15px var(--amber-glow); }
        .type-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 10px; }
        .type-btn { padding: 10px; background: rgba(0,0,0,0.5); border: 1px solid var(--amber-dim); color: var(--amber-dim); text-align: center; cursor: pointer; font-weight: bold; border-radius: 0; }
        .type-btn.active { border-color: var(--amber-glow); color: var(--amber-glow); background: rgba(255,174,0,0.1); }
        .chord-display-area { width: 240px; height: 300px; border: 2px solid var(--amber-glow); position: relative; box-shadow: 0 0 20px rgba(255, 174, 0, 0.1), inset 0 0 20px rgba(255, 174, 0, 0.1); background: rgba(10, 5, 0, 0.8); border-radius: 0; }
        
        /* STRUM BUTTON */
        .strum-btn {
            width: 100%; padding: 10px; margin-top: 15px;
            background: rgba(255, 174, 0, 0.1); border: 1px solid var(--amber-glow);
            color: var(--amber-glow); font-family: 'Teko'; font-size: 1.5rem;
            cursor: pointer; transition: 0.2s;
        }
        .strum-btn:hover { background: var(--amber-glow); color: black; box-shadow: 0 0 15px var(--amber-glow); }
        .strum-btn:active { transform: scale(0.98); }

        .pos-controls { display: flex; align-items: center; gap: 20px; margin-top: 15px; }
        .pos-btn { background: transparent; border: 1px solid var(--amber-dim); color: var(--amber-glow); padding: 5px 15px; cursor: pointer; font-weight: bold; transition: 0.2s; border-radius: 0; }
        .pos-btn:hover { background: var(--amber-glow); color: black; }
        .pos-indicator { font-family: monospace; color: var(--amber-glow); }

        /* --- METRONOME VISUALS --- */
        .metro-display {
            width: 250px; height: 250px;
            border: 4px solid #333; border-radius: 50%;
            margin: 20px auto; position: relative;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            box-shadow: 0 0 30px rgba(0,0,0,0.5);
            transition: 0.1s;
        }
        .metro-active { border-color: var(--pink-flux); box-shadow: 0 0 50px var(--pink-flux); }
        .metro-active.beat { transform: scale(1.05); background: rgba(255,0,85,0.1); }
        .metro-bpm-val { font-family: 'Teko'; font-size: 7rem; line-height: 1; color: white; }
        .metro-label { font-family: monospace; color: var(--pink-flux); font-size: 1rem; }
        .metro-controls { display: flex; justify-content: center; gap: 20px; margin-top: 20px; }
        .metro-btn { width: 60px; height: 60px; border: 1px solid var(--pink-flux); background: rgba(0,0,0,0.3); color: white; font-size: 1.5rem; cursor: pointer; display: flex; justify-content: center; align-items: center; transition: 0.2s; }
        .metro-btn:hover { background: var(--pink-flux); color: black; }
        .tap-btn { width: 100%; padding: 20px; background: rgba(255, 0, 85, 0.1); border: 2px solid var(--pink-flux); color: var(--pink-flux); font-weight: bold; font-size: 1.2rem; cursor: pointer; margin-top: 20px; transition: 0.1s; }
        .tap-btn:active { background: var(--pink-flux); color: white; transform: scale(0.98); }

        /* --- RADAR UI --- */
        .radar-container { position: relative; width: 300px; height: 300px; margin: 20px auto; }
        .radar-circle { width: 100%; height: 100%; border-radius: 50%; border: 2px solid rgba(189, 0, 255, 0.3); position: relative; animation: rotateScan 10s linear infinite; }
        .radar-circle::after { content: ''; position: absolute; top: 0; left: 50%; width: 50%; height: 2px; background: var(--purple-nebula); transform-origin: left; box-shadow: 0 0 10px var(--purple-nebula); }
        @keyframes rotateScan { to { transform: rotate(360deg); } }
        .radar-center { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); text-align: center; z-index: 10; background: var(--hud-bg); border-radius: 50%; width: 100px; height: 100px; display:flex; flex-direction:column; justify-content:center; align-items:center; border: 2px solid var(--purple-nebula); box-shadow: 0 0 20px rgba(189,0,255,0.2); }
        .radar-key-display { font-family: 'Teko'; font-size: 3rem; color: white; line-height: 0.8; }
        .radar-subtitle { color: var(--purple-nebula); font-size: 0.8rem; letter-spacing: 2px; }
        .radar-segment { position: absolute; top: 50%; left: 50%; width: 20px; height: 140px; transform-origin: bottom center; display: flex; flex-direction: column; align-items: center; justify-content: flex-start; cursor: pointer; transition: 0.2s; color: #555; font-weight: bold; }
        .radar-segment:hover { color: var(--purple-nebula); text-shadow: 0 0 10px var(--purple-nebula); transform: translate(-50%, -100%) scale(1.1); }
        .radar-scan-line { position: absolute; top: 0; left: 50%; width: 50%; height: 2px; background: var(--purple-nebula); transform-origin: left; box-shadow: 0 0 10px var(--purple-nebula); transition: transform 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275); z-index: 0; }
        .squad-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-top: 30px; }
        .squad-box { border: 1px solid var(--purple-nebula); padding: 10px; text-align: center; cursor: pointer; transition: 0.2s; background: rgba(189,0,255,0.05); }
        .squad-box:hover { background: var(--purple-nebula); color: black; transform: translateY(-3px); box-shadow: 0 0 15px var(--purple-nebula); }
        .squad-box:hover .squad-chord { color: black; }
        .squad-role { font-size: 0.7rem; color: #aaa; }
        .squad-chord { font-family: 'Teko'; font-size: 1.5rem; color: white; }

        /* --- TUNER UI --- */
        .tuner-display-ring { width: 200px; height: 200px; border: 5px solid #333; border-radius: 50%; margin: 20px auto; position: relative; display: flex; flex-direction: column; justify-content: center; align-items: center; box-shadow: 0 0 20px rgba(0,0,0,0.5); }
        .tuner-note-main { font-family: 'Teko'; font-size: 6rem; color: #555; line-height: 1; }
        .tuner-hz-sub { font-family: monospace; color: #555; font-size: 1rem; margin-top: 5px; }
        .tuner-active .tuner-display-ring { border-color: var(--green-signal); box-shadow: 0 0 30px var(--green-signal); }
        .tuner-active .tuner-note-main { color: white; text-shadow: 0 0 20px var(--green-signal); }
        .needle { position: absolute; bottom: 50%; left: 50%; width: 4px; height: 90px; background: red; transform-origin: bottom center; transform: translateX(-50%) rotate(0deg); transition: transform 0.1s; z-index: 10; border-radius: 0; }
        .needle.in-tune { background: var(--green-signal); box-shadow: 0 0 10px var(--green-signal); }

        /* --- SCALES UI --- */
        .scale-ui-header { display: flex; justify-content: space-between; align-items: center; }
        .scale-ui-controls { display: flex; gap: 20px; margin-top: 20px; flex-wrap: wrap; }
        .scale-control-group { flex: 1; }
        .notes-readout { margin-top: 15px; padding: 10px; background: rgba(0, 168, 255, 0.1); border: 1px solid var(--holo-blue); border-radius: 0; color: white; font-family: monospace; letter-spacing: 1px; text-align: center; }
        .fretboard-container { width: 100%; height: 150px; background: #111; border: 1px solid #333; position: relative; margin-top: 20px; overflow-x: auto; white-space: nowrap; border-radius: 0; }
        .fb-string { height: 25px; width: 1200px; border-bottom: 1px solid #444; position: relative; display: flex; align-items: center; }
        .fb-note { position: absolute; width: 18px; height: 18px; background: var(--holo-blue); border-radius: 50%; transform: translateX(-50%); box-shadow: 0 0 10px var(--holo-blue); z-index: 2; display: flex; justify-content: center; align-items: center; font-size: 9px; color: black; font-weight: bold; cursor: pointer; transition: 0.1s; }
        .fb-note:hover, .fb-note.playing { transform: translateX(-50%) scale(1.5); background: white; box-shadow: 0 0 15px white; }
        .fb-root { background: var(--alert-red); box-shadow: 0 0 10px var(--alert-red); z-index: 3; width: 22px; height: 22px;}

        /* --- BIO UI --- */
        .bio-grid { display: grid; grid-template-columns: 1fr; gap: 15px; width: 100%; }
        .bio-row { display: flex; justify-content: space-between; align-items: center; background: rgba(255, 174, 0, 0.05); border: 1px solid rgba(255, 174, 0, 0.2); padding: 15px; transition: 0.3s; opacity: 0; transform: translateX(-20px); animation: slideInRow 0.5s forwards; }
        .bio-row:hover { background: rgba(255, 174, 0, 0.15); border-color: var(--amber-glow); box-shadow: -5px 0 0 var(--amber-glow); }
        .bio-label { color: var(--amber-dim); font-size: 0.9rem; letter-spacing: 2px; font-weight: bold; }
        .bio-val { color: var(--amber-glow); font-size: 1.2rem; font-weight: bold; text-align: right; }
        .bio-row:nth-child(1) { animation-delay: 0.1s; } .bio-row:nth-child(2) { animation-delay: 0.2s; } .bio-row:nth-child(3) { animation-delay: 0.3s; } .bio-row:nth-child(4) { animation-delay: 0.4s; } .bio-row:nth-child(5) { animation-delay: 0.5s; }
        @keyframes slideInRow { to { opacity: 1; transform: translateX(0); } }
        
        /* --- UTILS --- */
        .status-text { font-family: monospace; color: var(--holo-blue); font-size: 0.9rem; margin-bottom: 10px; display: flex; justify-content: space-between; }
        .reticle { width: 150px; height: 150px; border: 1px solid var(--holo-cyan); border-radius: 50%; position: relative; display: flex; justify-content: center; align-items: center; margin-bottom: 10px; animation: rotateReticle 10s linear infinite; }
        .reticle::before { content: ''; position: absolute; width: 130px; height: 130px; border: 1px dashed var(--holo-blue); border-radius: 50%; animation: rotateReticle 5s linear infinite reverse; }
        .crosshair { position: absolute; width: 10px; height: 10px; background: var(--alert-red); border-radius: 50%; box-shadow: 0 0 10px var(--alert-red); }
        @keyframes rotateReticle { 100% { transform: rotate(360deg); } }

        /* --- MEDIA QUERIES (MOBILE) --- */
        @media (max-width: 768px) {
            .hero-title { font-size: 4rem; letter-spacing: 2px; }
            .hero-title::after { width: 100px; }
            .btn-group { flex-direction: column; align-items: center; gap: 15px; width: 100%; }
            .init-btn { width: 80%; padding: 15px 0; text-align: center; font-size: 1.2rem; }
            .tactical-panel { width: 95%; padding: 20px; max-height: 85vh; overflow-y: auto; } 
            #screen-more h2 { font-size: 3rem !important; margin-bottom: 20px !important; }
            #screen-chords .tactical-panel { flex-direction: column-reverse; }
            .chord-ui-right { border-left: none; border-bottom: 1px solid rgba(255,174,0,0.2); padding-left: 0; padding-bottom: 20px; margin-bottom: 20px; }
            .chord-display-area { margin: 0 auto; }
            .list-container { grid-template-columns: 1fr; height: 60vh; }
            #screen-deploy { justify-content: flex-start; padding-top: 80px; overflow-y: auto; }
            .deploy-header h1 { font-size: 3rem !important; }
            .deploy-grid { flex-direction: column; gap: 15px; width: 100%; padding-bottom: 40px; }
            .deploy-card { width: 100%; height: auto; flex-direction: row; align-items: center; padding: 15px; min-height: 80px; }
            .deploy-icon { font-size: 1.8rem; margin-top: 0; width: 50px; text-align: left;}
            .deploy-name { font-size: 1.5rem; text-align: left; }
            .deploy-btn { width: auto; padding: 8px 15px; margin-left: auto; font-size: 0.9rem; }
            .deploy-card div[style*="color:#666"] { display: none; } 
            #screen-scales .tactical-panel { flex-direction: column; }
            .scale-ui-controls { flex-direction: column; gap: 10px; } 
            .scale-control-group { width: 100%; }
            .fretboard-container { height: 180px; }
            #screen-about h2 { font-size: 2.5rem !important; }
            .bio-grid { gap: 10px; }
            .bio-row { flex-direction: column; align-items: flex-start; gap: 5px; padding: 15px; }
            .bio-label { font-size: 0.8rem; opacity: 0.8; }
            .bio-val { text-align: left; width: 100%; font-size: 1.1rem; word-break: break-word; color: var(--amber-glow); }
            .tuner-display-ring { width: 150px; height: 150px; }
            .tuner-note-main { font-size: 4rem; }
            .radar-container { width: 250px; height: 250px; }
        }
    </style>
</head>
<body>

    <div class="vignette"></div>
    <canvas id="grid-canvas"></canvas>

    <!-- SCREEN 1: INTRO -->
    <div id="screen-intro" class="screen active">
        <div class="hero-title">CHORD<br>SLAYER</div>
        <div style="letter-spacing: 4px; color: var(--holo-blue); margin-top: -10px; font-size: clamp(0.8rem, 2vw, 1rem);">TACTICAL AUDIO RECON</div>
        <div class="btn-group">
            <button class="init-btn" onclick="nav('screen-search')">INITIALIZE SCAN</button>
            <button class="init-btn variant" onclick="nav('screen-more')">MORE</button>
        </div>
    </div>

    <!-- SCREEN: MORE OPS -->
    <div id="screen-more" class="screen">
        <button class="back-btn" onclick="nav('screen-intro')" style="color:var(--amber-glow); border-color:var(--amber-glow);">&lt; BACK</button>
        <h2 style="font-family: 'Teko'; font-size: 4rem; color: var(--amber-glow); margin-bottom: 40px; text-align:center;">EXTENDED PROTOCOLS</h2>
        <div class="btn-group" style="flex-direction: column; align-items: center; width: 100%;">
            <button class="init-btn variant" style="width: 300px; max-width:90%;" onclick="nav('screen-chords')">CHORD DATA BANK</button>
            <button class="init-btn pink" style="width: 300px; max-width:90%;" onclick="nav('screen-metronome')">RHYTHM SYNC</button>
            <button class="init-btn purple" style="width: 300px; max-width:90%;" onclick="nav('screen-radar')">HARMONIC RADAR</button>
            <button class="init-btn green" style="width: 300px; max-width:90%;" onclick="nav('screen-tuner')">LIVE TUNER [BETA]</button>
            <button class="init-btn secondary" style="width: 300px; max-width:90%;" onclick="nav('screen-scales')">SCALE VECTOR MAP</button>
            <button class="init-btn variant" style="width: 300px; max-width:90%;" onclick="nav('screen-about')">OPERATOR PROFILE</button>
        </div>
    </div>

    <!-- SCREEN: TUNER (LIVE) -->
    <div id="screen-tuner" class="screen">
        <button class="back-btn" onclick="stopTuner(); nav('screen-more')" style="color:var(--green-signal); border-color:var(--green-signal);">&lt; RETURN</button>
        <div class="tactical-panel" style="display:block; text-align:center; border-color: var(--green-signal);">
            <div class="panel-accent pa-tl"></div><div class="panel-accent pa-tr"></div>
            <div class="panel-accent pa-bl"></div><div class="panel-accent pa-br"></div>
            <div style="color:var(--green-signal); letter-spacing:2px; margin-bottom:20px;">REAL-TIME PITCH DETECTION</div>
            <div id="tuner-ui" class="">
                <div class="tuner-display-ring">
                    <div class="needle" id="tuner-needle"></div>
                    <div class="tuner-note-main" id="tuner-note">--</div>
                    <div class="tuner-hz-sub" id="tuner-hz">0.0 Hz</div>
                </div>
            </div>
            <button class="init-btn green" id="mic-btn" onclick="startTuner()" style="margin-top:20px;">ACTIVATE MIC</button>
            <div style="margin-top:15px; font-size:0.8rem; color:#777;">ALLOW BROWSER MICROPHONE PERMISSION</div>
        </div>
    </div>

    <!-- SCREEN: SCALES -->
    <div id="screen-scales" class="screen">
        <button class="back-btn" onclick="nav('screen-more')" style="color:var(--holo-blue); border-color:var(--holo-blue);">&lt; RETURN</button>
        <div class="tactical-panel" style="flex-direction: column; align-items: stretch; border-color: var(--holo-blue);">
            <div class="panel-accent pa-tl"></div><div class="panel-accent pa-tr"></div>
            <div class="panel-accent pa-bl"></div><div class="panel-accent pa-br"></div>
            <div class="scale-ui-header">
                <h2 style="font-family:'Teko'; color:var(--holo-blue); margin:0;">SCALE MAP</h2>
                <div style="font-size:0.8rem; color:var(--holo-blue);">ROOT: <span id="scale-root-display">C</span> | TYPE: <span id="scale-type-display">MAJOR</span></div>
            </div>
            <div class="scale-ui-controls">
                <div class="scale-control-group">
                    <label style="color:#555; font-size:0.7rem;">ROOT KEY</label>
                    <div class="keypad-grid" id="scale-root-grid" style="grid-template-columns: repeat(7, 1fr);"></div>
                </div>
                <div class="scale-control-group">
                    <label style="color:#555; font-size:0.7rem;">SCALE TYPE</label>
                    <div style="display:flex; gap:5px; margin-top:5px;">
                        <div class="type-btn active" onclick="setScaleType('Major', this)">MAJ</div>
                        <div class="type-btn" onclick="setScaleType('Minor', this)">MIN</div>
                        <div class="type-btn" onclick="setScaleType('Pentatonic', this)">PENTA</div>
                    </div>
                </div>
            </div>
            <div class="notes-readout" id="scale-notes-text">NOTES: C - D - E - F - G - A - B</div>
            <div class="fretboard-container" id="fretboard"></div>
            <div style="display:flex; justify-content:space-between; color:#555; font-size:0.7rem; padding:0 10px;"><span>NUT (0)</span><span>3</span><span>5</span><span>7</span><span>9</span><span>12</span></div>
            <div style="color:var(--holo-blue); font-size:0.7rem; text-align:center; margin-top:5px;">CLICK NOTE TO PLAY</div>
        </div>
    </div>

    <!-- SCREEN: METRONOME (RHYTHM SYNC) -->
    <div id="screen-metronome" class="screen">
        <button class="back-btn" onclick="stopMetro(); nav('screen-more')" style="color:var(--pink-flux); border-color:var(--pink-flux);">&lt; BACK</button>
        <div class="tactical-panel" style="border-color: var(--pink-flux);">
            <div class="panel-accent pa-tl"></div><div class="panel-accent pa-tr"></div>
            <div class="panel-accent pa-bl"></div><div class="panel-accent pa-br"></div>
            
            <div style="color:var(--pink-flux); letter-spacing:2px; margin-bottom:20px;">TACTICAL RHYTHM SYNCHRONIZATION</div>
            
            <div class="metro-display" id="metro-radar">
                <div class="metro-bpm-val" id="metro-bpm-display">120</div>
                <div class="metro-label">BPM</div>
            </div>
            
            <div class="metro-controls">
                <button class="metro-btn" onclick="adjustBpm(-1)">-</button>
                <button class="init-btn pink" id="metro-toggle-btn" onclick="toggleMetronome()">START</button>
                <button class="metro-btn" onclick="adjustBpm(1)">+</button>
            </div>
            
            <button class="tap-btn" id="tap-btn" onmousedown="tapTempo()">ACQUIRE SIGNAL (TAP)</button>
        </div>
    </div>

    <!-- SCREEN: HARMONIC RADAR (Circle of Fifths) -->
    <div id="screen-radar" class="screen">
        <button class="back-btn" onclick="nav('screen-more')" style="color:var(--purple-nebula); border-color:var(--purple-nebula);">&lt; BACK</button>
        <div class="tactical-panel" style="border-color: var(--purple-nebula);">
            <div class="panel-accent pa-tl"></div><div class="panel-accent pa-tr"></div>
            <div class="panel-accent pa-bl"></div><div class="panel-accent pa-br"></div>
            
            <div style="color:var(--purple-nebula); letter-spacing:2px;">HARMONIC COMPATIBILITY SCANNER</div>
            
            <div class="radar-container" id="radar-ring">
                <!-- Segments JS Injected -->
                <div class="radar-scan-line" id="radar-line"></div>
                <div class="radar-center">
                    <div class="radar-key-display" id="radar-key">C</div>
                    <div class="radar-subtitle">MAJOR</div>
                </div>
            </div>
            
            <div style="display:flex; gap:10px; justify-content:center; margin-bottom:10px;">
                <button class="metro-btn" style="border-color:var(--purple-nebula);" onclick="rotateRadar(-1)">&lt;</button>
                <div style="color:#aaa; font-size:0.8rem; padding:10px;">ROTATE KEY VECTOR</div>
                <button class="metro-btn" style="border-color:var(--purple-nebula);" onclick="rotateRadar(1)">&gt;</button>
            </div>

            <div style="color:white; font-size:1.2rem; margin-bottom:10px;">SQUAD CHORDS (DIATONIC)</div>
            <div class="squad-grid" id="squad-grid">
                <!-- Generated via JS -->
            </div>
        </div>
    </div>

    <!-- SCREEN: ABOUT ME -->
    <div id="screen-about" class="screen">
        <button class="back-btn" onclick="nav('screen-more')" style="color:var(--amber-glow); border-color:var(--amber-glow);">&lt; RETURN</button>
        <div class="tactical-panel" style="border-color: var(--amber-glow);">
            <div class="panel-accent pa-tl"></div><div class="panel-accent pa-tr"></div>
            <div class="panel-accent pa-bl"></div><div class="panel-accent pa-br"></div>
            <div class="status-text" style="color: var(--amber-glow); margin-bottom: 20px;"><span>ID: CREATOR</span><span>ACCESS: GRANTED</span></div>
            <h2 style="font-family: 'Teko'; font-size: 3rem; color: var(--amber-glow); margin-bottom: 20px; border-bottom: 1px solid var(--amber-dim);">OPERATOR BIO</h2>
            <div class="bio-grid">
                <div class="bio-row"><span class="bio-label">NAME</span><span class="bio-val">SHREYASH MOHAN SHINDE</span></div>
                <div class="bio-row"><span class="bio-label">AGE</span><span class="bio-val">18 YEARS</span></div>
                <div class="bio-row"><span class="bio-label">EXPERIENCE</span><span class="bio-val">8 YEARS [GUITAR]</span></div>
                <div class="bio-row"><span class="bio-label">INSTAGRAM</span><span class="bio-val">@strumguitar13</span></div>
                <div class="bio-row"><span class="bio-label">YOUTUBE</span><span class="bio-val">AX CREST</span></div>
            </div>
            <div style="margin-top: 30px; font-size: 0.8rem; color: var(--amber-dim); text-align: center;">SYSTEM ARCHITECT // TACTICAL AUDIO INTERFACE</div>
        </div>
    </div>

    <!-- SCREEN 2: SEARCH (Main) -->
    <div id="screen-search" class="screen">
        <button class="back-btn" onclick="nav('screen-intro')">&lt; DISCONNECT</button>
        <div class="tactical-panel">
            <div class="panel-accent pa-tl"></div><div class="panel-accent pa-tr"></div>
            <div class="panel-accent pa-bl"></div><div class="panel-accent pa-br"></div>
            <div class="status-text"><span>STATUS: IDLE</span><span>SYS.READY</span></div>
            <div class="input-group">
                <label style="color: var(--holo-blue); letter-spacing: 2px; font-size: 0.9rem;">ENTER AUDIO SIGNATURE</label>
                <input type="text" id="song-input" class="tactical-input" placeholder="SONG / ARTIST" autocomplete="off">
            </div>
            <div style="margin-top: 20px; font-size: 0.8rem; color: #555;">PRESS <span style="color: white; border: 1px solid #555; padding: 2px 5px;">ENTER</span> TO SCAN</div>
        </div>
    </div>

    <!-- SCREEN 3: LIST -->
    <div id="screen-list" class="screen">
        <button class="back-btn" onclick="nav('screen-search')">&lt; CANCEL</button>
        <h2 style="font-family: 'Teko'; font-size: clamp(2rem, 5vw, 3rem); color: white; text-align: center;">SIGNALS DETECTED</h2>
        <div class="list-container" id="list-container"></div>
        <div id="loader" style="display:none; flex-direction:column; align-items:center;">
            <div class="scanner-bar"><div class="scanner-fill"></div></div>
            <div style="margin-top: 10px; letter-spacing: 3px; text-align:center; font-size: 0.8rem;">INTERCEPTING DATA STREAMS...</div>
        </div>
    </div>

    <!-- SCREEN 4: DEPLOY -->
    <div id="screen-deploy" class="screen">
        <button class="back-btn" onclick="nav('screen-list')">&lt; ABORT</button>
        <div class="reticle"><div class="crosshair"></div></div>
        <div class="deploy-header">
            <div style="color: var(--alert-red); letter-spacing: 5px; font-weight: bold; font-size: 0.8rem;">TARGET LOCKED</div>
            <h1 id="deploy-title" style="font-family: 'Teko'; font-size: 4rem; color: white; line-height: 1;">SONG NAME</h1>
            <h3 id="deploy-artist" style="color: var(--holo-blue); letter-spacing: 2px;">ARTIST NAME</h3>
        </div>
        <div class="deploy-grid" id="deploy-container"></div>
    </div>

    <!-- SCREEN 5: CHORD BANK -->
    <div id="screen-chords" class="screen">
        <button class="back-btn" onclick="nav('screen-more')" style="color:var(--amber-glow); border-color:var(--amber-glow);">&lt; BACK</button>
        <div class="tactical-panel">
            <div class="panel-accent pa-tl"></div><div class="panel-accent pa-tr"></div>
            <div class="panel-accent pa-bl"></div><div class="panel-accent pa-br"></div>
            <div class="chord-ui-left">
                <div class="status-text" style="color: var(--amber-glow);"><span>ARCHIVE: RESTRICTED</span><span>LEVEL 5</span></div>
                <label style="color: var(--amber-glow); letter-spacing: 2px;">SELECT ROOT KEY</label>
                <div class="keypad-grid" id="chord-root-grid"></div>
                <label style="color: var(--amber-glow); letter-spacing: 2px; margin-top:10px;">VARIATION</label>
                <div class="type-grid" id="chord-type-grid">
                    <div class="type-btn active" onclick="setChordType('Maj')">MAJ</div>
                    <div class="type-btn" onclick="setChordType('Min')">MIN</div>
                    <div class="type-btn" onclick="setChordType('7')">7</div>
                    <div class="type-btn" onclick="setChordType('Dim')">DIM</div>
                    <div class="type-btn" onclick="setChordType('Aug')">AUG</div>
                </div>
            </div>
            <div class="chord-ui-right">
                <div id="chord-name-display" style="font-family:'Teko'; font-size: 4rem; color: var(--amber-glow); line-height:1;">C MAJ</div>
                <div class="chord-display-area" id="chord-svg-container"></div>
                <button class="strum-btn" onclick="triggerStrum()">â–º STRUM</button>
                <div class="pos-controls">
                    <button class="pos-btn" onclick="changePos(-1)">&lt;</button>
                    <div class="pos-indicator" id="pos-display">POS 1/1</div>
                    <button class="pos-btn" onclick="changePos(1)">&gt;</button>
                </div>
                <div style="color: var(--amber-dim); margin-top:10px; font-size:0.8rem;">FINGER POSITIONS DECRYPTED</div>
            </div>
        </div>
    </div>

    <script>
        // --- 0. AUDIO CONTEXT INIT ---
        let audioCtx = null; // Shared Audio Context

        // --- 1. NAVIGATION & THEMES ---
        window.nav = function(id) {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById(id).classList.add('active');
            if(id === 'screen-search') setTimeout(() => document.getElementById('song-input').focus(), 600);
            
            // Dynamic Theme Logic
            if(id.includes('chords') || id.includes('more') || id.includes('about')) {
                document.body.style.setProperty('--holo-cyan', '#ffae00'); // Amber
            } else if(id.includes('tuner')) {
                document.body.style.setProperty('--holo-cyan', '#00ff41'); // Green
            } else if(id.includes('scales')) {
                document.body.style.setProperty('--holo-cyan', '#00a8ff'); // Blue
            } else if(id.includes('metronome')) {
                document.body.style.setProperty('--holo-cyan', '#ff0055'); // Pink
            } else if(id.includes('radar')) {
                document.body.style.setProperty('--holo-cyan', '#bd00ff'); // Purple
            } else {
                document.body.style.setProperty('--holo-cyan', '#00f0ff'); // Cyan Default
            }
        };

        // --- 2. CHORD AUDIO ENGINE ---
        const stringBaseFreqs = [82.41, 110.00, 146.83, 196.00, 246.94, 329.63]; // E2 A2 D3 G3 B3 E4

        function playNote(freq, startTime, duration) {
            if(!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            
            osc.type = 'triangle'; // Richer than sine
            osc.frequency.value = freq;
            
            // Envelope
            gain.gain.setValueAtTime(0, startTime);
            gain.gain.linearRampToValueAtTime(0.2, startTime + 0.05); // Attack
            gain.gain.exponentialRampToValueAtTime(0.001, startTime + duration); // Decay
            
            osc.connect(gain);
            gain.connect(audioCtx.destination);
            
            osc.start(startTime);
            osc.stop(startTime + duration);
        }

        window.triggerStrum = function() {
            const variants = chordData[currentRoot][currentType] || [];
            const currentChord = variants[currentPosIndex] || { f: 1, p: [0,0,0,0,0,0] };
            const fingering = currentChord.p;
            const startFret = currentChord.f;

            if(!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            const now = audioCtx.currentTime;

            // Visual Feedback
            document.querySelector('.chord-display-area').style.boxShadow = "0 0 50px var(--amber-glow)";
            setTimeout(() => document.querySelector('.chord-display-area').style.boxShadow = "0 0 20px var(--amber-glow), inset 0 0 20px var(--amber-glow)", 300);

            // Play Strings
            let stringCount = 0;
            fingering.forEach((fret, stringIdx) => {
                if (fret === 'x') return;
                const freq = stringBaseFreqs[stringIdx] * Math.pow(2, fret / 12);
                playNote(freq, now + (stringCount * 0.05), 2.0); // 50ms stagger
                stringCount++;
            });
        };


        // --- 3. SCALE SYSTEM (WITH AUDIO) ---
        let scaleRoot = 'C', scaleType = 'Major';
        const scaleNotes = ['C','C#','D','D#','E','F','F#','G','G#','A','A#','B'];
        const scalesDict = { 'Major': [0,2,4,5,7,9,11], 'Minor': [0,2,3,5,7,8,10], 'Pentatonic': [0,3,5,7,10] };
        const stringOffsets = [4, 9, 2, 7, 11, 4];

        function initScales() {
            const grid = document.getElementById('scale-root-grid');
            ['C','D','E','F','G','A','B'].forEach(r => {
                const btn = document.createElement('div'); btn.className = 'key-btn';
                if(r === 'C') btn.classList.add('active'); btn.innerText = r;
                btn.onclick = () => { document.querySelectorAll('#scale-root-grid .key-btn').forEach(b => b.classList.remove('active')); btn.classList.add('active'); scaleRoot = r; renderScaleBoard(); };
                grid.appendChild(btn);
            });
            renderScaleBoard();
        }
        window.setScaleType = function(type, btn) { scaleType = type; document.querySelectorAll('#screen-scales .type-btn').forEach(b => b.classList.remove('active')); btn.classList.add('active'); renderScaleBoard(); }
        
        function renderScaleBoard() {
            document.getElementById('scale-root-display').innerText = scaleRoot;
            document.getElementById('scale-type-display').innerText = scaleType.toUpperCase();
            const container = document.getElementById('fretboard'); container.innerHTML = '';
            const rootIndex = scaleNotes.indexOf(scaleRoot);
            const scaleNotesIndices = scalesDict[scaleType].map(i => (rootIndex + i) % 12);
            document.getElementById('scale-notes-text').innerText = `NOTES: ${scaleNotesIndices.map(i => scaleNotes[i]).join(' - ')}`;
            
            for(let s=5; s>=0; s--) {
                const stringRow = document.createElement('div'); stringRow.className = 'fb-string';
                for(let f=0; f<=13; f++) {
                    const currentNoteIndex = (stringOffsets[s] + f) % 12;
                    if(scaleNotesIndices.includes(currentNoteIndex)) {
                        const noteDot = document.createElement('div'); 
                        noteDot.className = 'fb-note'; 
                        noteDot.style.left = ((f * 85) + 40) + "px"; 
                        noteDot.innerText = scaleNotes[currentNoteIndex];
                        
                        // CLICK TO PLAY NOTE
                        noteDot.onclick = () => {
                            const freq = stringBaseFreqs[s] * Math.pow(2, f / 12);
                            playNote(freq, audioCtx ? audioCtx.currentTime : 0, 1.0);
                            noteDot.classList.add('playing');
                            setTimeout(() => noteDot.classList.remove('playing'), 200);
                        };

                        if(currentNoteIndex === rootIndex) noteDot.classList.add('fb-root'); 
                        stringRow.appendChild(noteDot);
                    }
                }
                container.appendChild(stringRow);
            }
            for(let f=1; f<=13; f++) { const bar = document.createElement('div'); bar.style.position='absolute'; bar.style.top='0'; bar.style.bottom='0'; bar.style.width='2px'; bar.style.background='#333'; bar.style.left=(f*85)+"px"; bar.style.zIndex='0'; container.appendChild(bar); }
        }

        // --- 4. LIVE TUNER (AUTOCORRELATION) ---
        let tunerCtx = null, tunerStream = null, analyser = null, isTunerRunning = false;
        const buflen = 2048, buf = new Float32Array(buflen);

        window.startTuner = async function() {
            if(isTunerRunning) return;
            const btn = document.getElementById('mic-btn');
            try {
                tunerCtx = new (window.AudioContext || window.webkitAudioContext)();
                tunerStream = await navigator.mediaDevices.getUserMedia({ audio: true });
                const source = tunerCtx.createMediaStreamSource(tunerStream);
                analyser = tunerCtx.createAnalyser(); analyser.fftSize = 2048; source.connect(analyser);
                isTunerRunning = true; btn.innerText = "MIC ACTIVE";
                document.getElementById('tuner-ui').classList.add('tuner-active'); updatePitch();
            } catch (err) { btn.innerText = "ACCESS DENIED"; btn.style.borderColor = "red"; btn.style.color = "red"; }
        };

        window.stopTuner = function() {
            isTunerRunning = false;
            if(tunerStream) tunerStream.getTracks().forEach(t => t.stop());
            if(tunerCtx) tunerCtx.close();
            document.getElementById('tuner-ui').classList.remove('tuner-active');
            document.getElementById('mic-btn').innerText = "ACTIVATE MIC";
        };

        function updatePitch() {
            if(!isTunerRunning) return;
            analyser.getFloatTimeDomainData(buf);
            const ac = autoCorrelate(buf, tunerCtx.sampleRate);
            const noteEl = document.getElementById('tuner-note');
            const hzEl = document.getElementById('tuner-hz');
            const needle = document.getElementById('tuner-needle');

            if (ac !== -1) {
                const pitch = ac;
                const note = noteFromPitch(pitch);
                const noteName = noteStrings[note % 12];
                const detune = centsOffFromPitch(pitch, note);
                noteEl.innerText = noteName;
                hzEl.innerText = Math.round(pitch) + " Hz";
                const rotation = Math.max(-45, Math.min(45, detune));
                needle.style.transform = `translateX(-50%) rotate(${rotation}deg)`;
                if(Math.abs(detune) < 5) { needle.classList.add('in-tune'); noteEl.style.color = "#00ff41"; } 
                else { needle.classList.remove('in-tune'); noteEl.style.color = "white"; }
            }
            requestAnimationFrame(updatePitch);
        }
        function noteFromPitch(frequency) { return Math.round(12 * (Math.log(frequency / 440) / Math.log(2)) + 69); }
        function centsOffFromPitch(frequency, note) { return Math.floor(1200 * Math.log(frequency / (440 * Math.pow(2, (note - 69) / 12))) / Math.log(2)); }
        function autoCorrelate(buf, sampleRate) {
            let SIZE = buf.length; let rms = 0; for (let i = 0; i < SIZE; i++) rms += buf[i] * buf[i]; rms = Math.sqrt(rms / SIZE);
            if (rms < 0.01) return -1;
            let r1 = 0, r2 = SIZE - 1, thres = 0.2;
            for (let i = 0; i < SIZE / 2; i++) if (Math.abs(buf[i]) < thres) { r1 = i; break; }
            for (let i = 1; i < SIZE / 2; i++) if (Math.abs(buf[SIZE - i]) < thres) { r2 = SIZE - i; break; }
            buf = buf.slice(r1, r2); SIZE = buf.length; let c = new Array(SIZE).fill(0);
            for (let i = 0; i < SIZE; i++) for (let j = 0; j < SIZE - i; j++) c[i] = c[i] + buf[j] * buf[j + i];
            let d = 0; while (c[d] > c[d + 1]) d++; let maxval = -1, maxpos = -1;
            for (let i = d; i < SIZE; i++) if (c[i] > maxval) { maxval = c[i]; maxpos = i; }
            let T0 = maxpos; return sampleRate / T0;
        }

        // --- 5. CHORD LOGIC (UPDATED DATA) ---
        const chordData = {
            'C': { 'Maj': [{f:1, p:[0,3,2,0,1,0]}, {f:3, p:['x',3,5,5,5,3]}], 'Min': [{f:3, p:['x',3,5,5,4,3]}], '7': [{f:1, p:[0,3,2,3,1,0]}], 'Dim': [{f:1, p:['x',3,4,2,4,'x']}], 'Aug': [{f:1, p:['x',3,2,1,1,0]}] },
            'D': { 'Maj': [{f:1, p:['x','x',0,2,3,2]}], 'Min': [{f:1, p:['x','x',0,2,3,1]}], '7': [{f:1, p:['x','x',0,2,1,2]}], 'Dim': [{f:1, p:['x','x',0,1,0,1]}], 'Aug': [{f:1, p:['x','x',0,3,3,2]}] },
            'E': { 'Maj': [{f:1, p:[0,2,2,1,0,0]}], 'Min': [{f:1, p:[0,2,2,0,0,0]}], '7': [{f:1, p:[0,2,0,1,0,0]}], 'Dim': [{f:1, p:['x','x',2,3,2,3]}], 'Aug': [{f:1, p:[0,3,2,1,1,0]}] },
            'F': { 'Maj': [{f:1, p:[1,3,3,2,1,1]}], 'Min': [{f:1, p:[1,3,3,1,1,1]}], '7': [{f:1, p:[1,3,1,2,1,1]}], 'Dim': [{f:1, p:['x','x',0,1,0,1]}], 'Aug': [{f:1, p:['x','x',3,2,2,1]}] },
            'G': { 'Maj': [{f:1, p:[3,2,0,0,0,3]}], 'Min': [{f:3, p:[3,5,5,3,3,3]}], '7': [{f:1, p:[3,2,0,0,0,1]}], 'Dim': [{f:1, p:['x','x',1,3,2,3]}], 'Aug': [{f:1, p:[3,2,1,0,0,3]}] },
            'A': { 'Maj': [{f:1, p:['x',0,2,2,2,0]}], 'Min': [{f:1, p:['x',0,2,2,1,0]}], '7': [{f:1, p:['x',0,2,0,2,0]}], 'Dim': [{f:1, p:['x',0,1,2,1,2]}], 'Aug': [{f:1, p:['x',0,3,2,2,1]}] },
            'B': { 'Maj': [{f:1, p:['x',2,4,4,4,2]}], 'Min': [{f:1, p:['x',2,4,4,3,2]}], '7': [{f:1, p:['x',2,1,2,0,2]}], 'Dim': [{f:1, p:['x',2,3,1,3,'x']}], 'Aug': [{f:1, p:['x',2,1,0,0,3]}] }
        };
        let currentRoot = 'C', currentType = 'Maj', currentPosIndex = 0;
        function initChordBank() { const grid = document.getElementById('chord-root-grid'); ['C','D','E','F','G','A','B'].forEach(root => { const btn = document.createElement('div'); btn.className = 'key-btn' + (root === 'C' ? ' active' : ''); btn.innerText = root; btn.onclick = () => { document.querySelectorAll('#chord-root-grid .key-btn').forEach(b => b.classList.remove('active')); btn.classList.add('active'); currentRoot = root; currentPosIndex=0; renderChord(); }; grid.appendChild(btn); }); renderChord(); }
        window.setChordType = function(type) { currentType = type; currentPosIndex = 0; document.querySelectorAll('#chord-type-grid .type-btn').forEach(b => { b.classList.remove('active'); if(b.innerText === type.toUpperCase()) b.classList.add('active'); }); renderChord(); };
        window.changePos = function(dir) { const variants = chordData[currentRoot][currentType] || []; if(!variants.length) return; currentPosIndex += dir; if(currentPosIndex >= variants.length) currentPosIndex = 0; if(currentPosIndex < 0) currentPosIndex = variants.length - 1; renderChord(); };
        function renderChord() {
            document.getElementById('chord-name-display').innerText = `${currentRoot} ${currentType.toUpperCase()}`;
            const variants = chordData[currentRoot][currentType] || []; const currentChord = variants[currentPosIndex] || { f: 1, p: [0,0,0,0,0,0] };
            document.getElementById('pos-display').innerText = `POS ${currentPosIndex + 1}/${Math.max(1, variants.length)}`;
            const container = document.getElementById('chord-svg-container'); container.innerHTML = '';
            const w = 240, h = 300, ns = "http://www.w3.org/2000/svg"; const svg = document.createElementNS(ns, "svg"); svg.setAttribute("width", "100%"); svg.setAttribute("height", "100%"); svg.setAttribute("viewBox", `0 0 ${w} ${h}`);
            const startFret = currentChord.f; const isNut = startFret === 1;
            if(!isNut) { const label = document.createElementNS(ns, "text"); label.setAttribute("x", 10); label.setAttribute("y", 65); label.setAttribute("fill", "#ffae00"); label.setAttribute("font-family", "Teko"); label.setAttribute("font-size", "20"); label.textContent = startFret + "fr"; svg.appendChild(label); }
            for(let i=0; i<6; i++) { const x = 40 + i * 32; const line = document.createElementNS(ns, "line"); line.setAttribute("x1", x); line.setAttribute("y1", 40); line.setAttribute("x2", x); line.setAttribute("y2", h-20); line.setAttribute("stroke", "#5c3d00"); line.setAttribute("stroke-width", "2"); svg.appendChild(line); }
            for(let i=0; i<5; i++) { const y = 40 + i * 50; const line = document.createElementNS(ns, "line"); line.setAttribute("x1", 40); line.setAttribute("y1", y); line.setAttribute("x2", 200); line.setAttribute("y2", y); line.setAttribute("stroke", "#ffae00"); line.setAttribute("stroke-width", (i===0 && isNut) ? "6" : "2"); svg.appendChild(line); }
            currentChord.p.forEach((fretVal, stringIndex) => { const x = 40 + stringIndex * 32; if (fretVal === 'x') { const text = document.createElementNS(ns, "text"); text.setAttribute("x", x); text.setAttribute("y", 30); text.setAttribute("fill", "#ffae00"); text.setAttribute("text-anchor", "middle"); text.textContent = "X"; svg.appendChild(text); } else if (fretVal === 0 && isNut) { const circle = document.createElementNS(ns, "circle"); circle.setAttribute("cx", x); circle.setAttribute("cy", 25); circle.setAttribute("r", "4"); circle.setAttribute("stroke", "#ffae00"); circle.setAttribute("fill", "none"); svg.appendChild(circle); } else { let relativeFret = fretVal - startFret + 1; if(relativeFret > 0 && relativeFret <= 5) { const y = 40 + (relativeFret * 50) - 25; const circle = document.createElementNS(ns, "circle"); circle.setAttribute("cx", x); circle.setAttribute("cy", y); circle.setAttribute("r", "12"); circle.setAttribute("fill", "#ffae00"); svg.appendChild(circle); } } });
            container.appendChild(svg);
        }

        // --- 6. METRONOME LOGIC ---
        let metroAudioCtx = null; let nextNoteTime = 0.0; let timerID = null; let bpm = 120; let isMetroRunning = false;
        const lookahead = 25.0; const scheduleAheadTime = 0.1;

        window.adjustBpm = function(amount) { bpm += amount; if(bpm < 40) bpm = 40; if(bpm > 300) bpm = 300; document.getElementById('metro-bpm-display').innerText = bpm; };
        window.toggleMetronome = function() {
            const btn = document.getElementById('metro-toggle-btn'); const radar = document.getElementById('metro-radar');
            if(isMetroRunning) { isMetroRunning = false; clearTimeout(timerID); btn.innerText = "START"; radar.classList.remove('metro-active'); return; }
            if(!metroAudioCtx) metroAudioCtx = new (window.AudioContext || window.webkitAudioContext)();
            isMetroRunning = true; nextNoteTime = metroAudioCtx.currentTime; btn.innerText = "STOP"; radar.classList.add('metro-active'); scheduler();
        };
        window.stopMetro = function() { if(isMetroRunning) toggleMetronome(); };
        function nextNote() { const secondsPerBeat = 60.0 / bpm; nextNoteTime += secondsPerBeat; }
        function playClick(time) {
            const osc = metroAudioCtx.createOscillator(); const gain = metroAudioCtx.createGain();
            osc.frequency.value = 1000; gain.gain.value = 1; gain.gain.exponentialRampToValueAtTime(0.001, time + 0.05);
            osc.connect(gain); gain.connect(metroAudioCtx.destination); osc.start(time); osc.stop(time + 0.05);
            setTimeout(() => { const radar = document.getElementById('metro-radar'); if(radar) { radar.classList.add('beat'); setTimeout(() => radar.classList.remove('beat'), 100); } }, (time - metroAudioCtx.currentTime) * 1000);
        }
        function scheduler() { while (nextNoteTime < metroAudioCtx.currentTime + scheduleAheadTime) { playClick(nextNoteTime); nextNote(); } if(isMetroRunning) timerID = setTimeout(scheduler, lookahead); }

        // Tap Tempo
        let lastTapTime = 0; let tapTimes = [];
        window.tapTempo = function() {
            const now = Date.now(); if (now - lastTapTime > 2000) tapTimes = [];
            tapTimes.push(now); lastTapTime = now; if (tapTimes.length > 4) tapTimes.shift();
            if (tapTimes.length > 1) {
                let intervals = []; for(let i = 0; i < tapTimes.length - 1; i++) { intervals.push(tapTimes[i+1] - tapTimes[i]); }
                const avgInterval = intervals.reduce((a,b) => a + b) / intervals.length; const newBpm = Math.round(60000 / avgInterval);
                bpm = newBpm; document.getElementById('metro-bpm-display').innerText = bpm;
                if(isMetroRunning) { nextNoteTime = metroAudioCtx.currentTime; }
            }
        };

        // --- 7. HARMONIC RADAR ---
        const radarKeys = ["C", "G", "D", "A", "E", "B", "F#", "Db", "Ab", "Eb", "Bb", "F"];
        const radarMinors = ["Am", "Em", "Bm", "F#m", "C#m", "G#m", "D#m", "Bbm", "Fm", "Cm", "Gm", "Dm"];
        let currentRadarIndex = 0;
        
        // Initialize Radar Segments
        function initRadar() {
            const ring = document.getElementById('radar-ring');
            radarKeys.forEach((key, index) => {
                const segment = document.createElement('div');
                segment.className = 'radar-segment';
                segment.innerText = key;
                segment.style.transform = `translate(-50%, -50%) rotate(${index * 30}deg)`;
                segment.onclick = () => {
                    // Calculate shortest path to rotate
                    let diff = index - currentRadarIndex;
                    // normalize to -6 to +6 for shortest path
                    if (diff > 6) diff -= 12;
                    if (diff < -6) diff += 12;
                    
                    currentRadarIndex = index;
                    // Animate line to point to new key
                    document.getElementById('radar-line').style.transform = `rotate(${index * 30}deg)`;
                    
                    // Play Root Chord of new Key
                    playKeyPreview(key);
                    
                    renderSquad();
                };
                ring.appendChild(segment);
            });
        }
        
        // Play a triad preview of the key
        function playKeyPreview(keyName) {
            if(!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            // Map Key Name to Frequency (Middle C octave)
            const rootMap = { 
                "C": 261.63, "C#": 277.18, "Db": 277.18, "D": 293.66, "Eb": 311.13, "E": 329.63, 
                "F": 349.23, "F#": 369.99, "G": 392.00, "Ab": 415.30, "A": 440.00, "Bb": 466.16, "B": 493.88 
            };
            const rootFreq = rootMap[keyName] || 261.63;
            
            // Major Triad: Root, Major 3rd (4 semitones), Perfect 5th (7 semitones)
            const thirdFreq = rootFreq * Math.pow(2, 4/12);
            const fifthFreq = rootFreq * Math.pow(2, 7/12);
            
            const now = audioCtx.currentTime;
            playNote(rootFreq, now, 1.5);
            playNote(thirdFreq, now + 0.1, 1.5);
            playNote(fifthFreq, now + 0.2, 1.5);
            
            // Visual pulse
            document.querySelector('.radar-center').style.boxShadow = "0 0 50px var(--purple-nebula)";
            setTimeout(() => document.querySelector('.radar-center').style.boxShadow = "0 0 20px rgba(189,0,255,0.2)", 300);
        }

        window.rotateRadar = function(dir) { 
            currentRadarIndex += dir; 
            if(currentRadarIndex >= 12) currentRadarIndex = 0; 
            if(currentRadarIndex < 0) currentRadarIndex = 11; 
            
            document.getElementById('radar-line').style.transform = `rotate(${currentRadarIndex * 30}deg)`;
            renderSquad(); 
            playKeyPreview(radarKeys[currentRadarIndex]);
        }
        
        function renderSquad() {
            const key = radarKeys[currentRadarIndex]; const relativeMinor = radarMinors[currentRadarIndex];
            const leftIndex = (currentRadarIndex + 11) % 12; const rightIndex = (currentRadarIndex + 1) % 12;
            const IV = radarKeys[leftIndex]; const V = radarKeys[rightIndex]; const ii = radarMinors[leftIndex]; const iii = radarMinors[rightIndex];
            document.getElementById('radar-key').innerText = key;
            const squad = [ {role: 'TONIC (I)', chord: key}, {role: 'SUBDOM (IV)', chord: IV}, {role: 'DOMINANT (V)', chord: V}, {role: 'REL. MIN (vi)', chord: relativeMinor}, {role: 'SUPERTONIC (ii)', chord: ii}, {role: 'MEDIANT (iii)', chord: iii} ];
            const grid = document.getElementById('squad-grid'); grid.innerHTML = "";
            squad.forEach(unit => { 
                const box = document.createElement('div'); 
                box.className = 'squad-box'; 
                box.innerHTML = `<div class="squad-role">${unit.role}</div><div class="squad-chord">${unit.chord}</div>`; 
                box.onclick = () => {
                    // Play single chord logic - approximated for now using the root logic
                    // Simplified: Just plays root note of that chord to indicate pitch
                    // Ideal: Connect to Chord Data Bank logic, but that requires complex lookup mapping
                    playKeyPreview(unit.chord.replace('m', '')); // Hack: Play major version for preview
                };
                grid.appendChild(box); 
            });
        }

        // --- 8. MAIN INIT ---
        (function() {
            initChordBank(); initScales(); initRadar(); renderSquad();
            const input = document.getElementById('song-input');
            if(input) { input.onkeypress = (e) => { if(e.key === 'Enter' && input.value.trim()) { input.blur(); runScan(input.value.trim()); } }; }
            async function runScan(query) {
                window.nav('screen-list');
                const container = document.getElementById('list-container');
                const loader = document.getElementById('loader');
                container.innerHTML = ''; loader.style.display = 'flex';
                try {
                    const res = await fetch(`https://itunes.apple.com/search?term=${encodeURIComponent(query)}&entity=song&limit=9`);
                    const data = await res.json(); loader.style.display = 'none';
                    if(data.resultCount === 0) { container.innerHTML = '<div style="grid-column: 1/-1; text-align: center;">NO SIGNATURE FOUND</div>'; return; }
                    data.results.forEach(track => {
                        const el = document.createElement('div'); el.className = 'data-card';
                        el.innerHTML = `<img src="${track.artworkUrl100}" class="card-img"><div style="flex: 1; min-width: 0;"><div style="font-weight:bold; font-size: 1.1rem; line-height:1; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">${track.trackName}</div><div style="color: var(--holo-blue); font-size: 0.9rem; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">${track.artistName}</div></div>`;
                        el.onclick = () => engageTarget(track); container.appendChild(el);
                    });
                } catch(e) { loader.style.display = 'none'; container.innerHTML = '<div style="text-align:center; color: red;">NETWORK ERROR</div>'; }
            }
            window.engageTarget = function(track) {
                document.getElementById('deploy-title').innerText = track.trackName; document.getElementById('deploy-artist').innerText = track.artistName;
                const q = encodeURIComponent(`${track.artistName} ${track.trackName}`);
                // Precise search string for the "Ducky" trick
                const duckyQuery = encodeURIComponent(`site:tabs.ultimate-guitar.com "${track.artistName}" "${track.trackName}" chords`);
                
                const providers = [
                    // UPDATED: Uses DuckDuckGo's '!ducky' bang to auto-redirect to the first result on UG
                    { name: "ULTIMATE GUITAR", icon: "âš¡", url: `https://duckduckgo.com/?q=!ducky+${duckyQuery}`, desc: "DIRECT LINK (AUTO)" },
                    { name: "CHORDIFY", icon: "ðŸŽ¹", url: `https://chordify.net/search/${q}`, desc: "AUTO-CHORD AI" },
                    { name: "SONGSTERR", icon: "ðŸŽ¼", url: `https://www.songsterr.com/a/wa/bestMatchForQueryString?s=${q}`, desc: "INTERACTIVE TAB" },
                    { name: "YOUTUBE", icon: "â–¶", url: `https://www.youtube.com/results?search_query=${q}+guitar+tutorial`, desc: "VIDEO INTEL" }
                ];
                const grid = document.getElementById('deploy-container'); grid.innerHTML = '';
                providers.forEach((p, i) => {
                    const card = document.createElement('div'); card.className = 'deploy-card'; card.style.animation = `fadeIn 0.5s ease ${i * 0.1}s backwards`;
                    card.innerHTML = `<div class="deploy-icon">${p.icon}</div><div style="text-align:center; flex: 1;"><div class="deploy-name">${p.name}</div><div style="color:#666; font-size:0.8rem; margin-top:5px;">${p.desc}</div></div><div class="deploy-btn">EXECUTE</div>`;
                    card.onclick = () => window.open(p.url, '_blank'); grid.appendChild(card);
                });
                window.nav('screen-deploy');
            };
            // Canvas Anim
            const canvas = document.getElementById('grid-canvas');
            if(canvas) {
                const ctx = canvas.getContext('2d'); let w, h;
                function resize() { w = window.innerWidth; h = window.innerHeight; canvas.width = w; canvas.height = h; }
                window.addEventListener('resize', resize); resize();
                let offset = 0;
                function draw() {
                    if(!document.body.contains(canvas)) return;
                    ctx.clearRect(0,0,w,h);
                    const style = getComputedStyle(document.body);
                    ctx.strokeStyle = style.getPropertyValue('--holo-cyan').trim();
                    ctx.lineWidth = 1; ctx.globalAlpha = 0.15;
                    const time = Date.now() * 0.001;
                    for(let i=0; i<h; i+=50) { let y = (i + offset) % h; ctx.beginPath(); ctx.moveTo(0, y); ctx.lineTo(w, y); ctx.stroke(); }
                    offset += 0.5;
                    for(let i=0; i<w; i+=100) { ctx.beginPath(); ctx.moveTo(i, 0); ctx.lineTo(i + Math.sin(time + i)*50, h); ctx.stroke(); }
                    requestAnimationFrame(draw);
                }
                draw();
            }
        })();

        if (!document.getElementById('dynamic-styles')) {
            const style = document.createElement('style'); style.id = 'dynamic-styles';
            style.innerHTML = `@keyframes fadeIn { from { opacity:0; transform:translateY(20px); } to { opacity:1; transform:translateY(0); } }`;
            document.head.appendChild(style);
        }
    </script>
</body>
</html>